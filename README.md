# タスクテンプレートシステム

統合タスクハンドラーにより、task3.py, task5.py, task6.py, task7.pyを1つのファイルで処理できるようになりました。

## ファイル構成

- **task_handler.py**: 統合タスクハンドラー（全タスクタイプを処理）
- **task_config.json**: タスク設定ファイル（テンプレートとマッピング定義）

## 設定構造 (task_config.json)

各タスクタイプには以下の設定が可能：

```json
{
  "タスク番号": {
    "name": "タスク名",
    "template": "テンプレートファイル名.xlsx",
    "title_replace": "タイトルから削除する文字列",
    "output_suffix": "出力ファイル名のサフィックス",
    "cell_mappings": {
      "セル位置": {
        "type": "マッピングタイプ",
        "key": "フィールド名",
        "format": "フォーマッタ名"
      }
    },
    "custom_processor": "カスタム処理メソッド名",
    "operation_records_start": 操作記録開始行,
    "operation_records_style": "simple/detailed",
    "operation_records_title": "操作記録のタイトル",
    "print_area": true/false,
    "print_mode": "a4/a4_singleside/conditional"
  }
}
```

### マッピングタイプ

- `business_id`: 審批編号
- `title_modified`: タイトル（title_replace適用後）
- `originator_dept`: 部門名
- `field`: フォームフィールドの値

### フォーマッタ

- `goods_detail`: 商品明細フォーマット
- `invoice_attachments`: 発票添付ファイルフォーマット

### 操作記録スタイル

- `simple`: 同意のみ表示
- `detailed`: 全操作を詳細表示

## 新しいタスクタイプの追加方法

1. **task_config.json**に新しいタスク設定を追加
2. 特殊な処理が必要な場合は**task_handler.py**にカスタムメソッドを追加
3. **main.py**の`ALL_TASKS`に新しいタスクを登録

## 使用例

```python
import task_handler

# タスク処理
result = task_handler.handle_task(
    pid="task_id",
    task_type=3,
    status="COMPLETED",
    title="タスクタイトル"
)
```

## 利点

1. **コードの重複削減**: 共通処理を1箇所で管理
2. **保守性向上**: 新しいタスクタイプを設定ファイルで追加可能
3. **柔軟性**: カスタム処理を必要に応じて追加可能
4. **統一性**: 全タスクで一貫した処理フロー


# 调试模式测试功能说明

## 功能描述

在调试模式下，可以从数据库中获取每种任务类型的最新一条记录进行测试，验证任务处理流程是否正常。

## 使用方法

### 1. 启用调试模式

创建 `.debug` 文件以启用调试模式：

```bash
touch .debug
```

### 2. 执行历史任务测试

创建 `.test` 文件以触发测试：

```bash
touch .test
```

然后运行程序：

```bash
python main.py
```

程序会：
1. 检测到 `.debug` 和 `.test` 文件
2. 从数据库中查找每种任务类型的最新记录
3. 依次执行这些任务的处理流程
4. 输出测试结果
5. 自动退出

### 3. 正常调试模式运行

如果只创建 `.debug` 文件（不创建 `.test` 文件），程序会正常运行，但：
- 不会实际处理任务（只标记为已处理）
- 不会捕获异常（便于调试）

### 4. 退出调试模式

删除 `.debug` 文件即可：

```bash
rm .debug
```

## 测试流程说明

测试功能会：

1. 查询数据库中所有任务类型
2. 对每种任务类型，获取最新的一条记录（优先COMPLETED状态）
3. 依次执行任务处理：
   - 调用 `task_handler.handle_task()`
   - 记录处理结果
   - 输出详细日志

4. 输出测试摘要

## 日志输出示例

```
========================================
调试模式：开始测试每种任务类型的最新记录
========================================
找到 4 种任务类型的最新记录

==================================================
[测试] 任务类型: 3, PID: xxxxx
[测试] 标题: 合作档口营业款付款申请, 状态: COMPLETED
==================================================
[测试成功] 任务类型 3 处理完成

...

========================================
调试模式：所有任务测试完成
========================================
```

## 注意事项

1. **数据要求**：数据库中必须存在历史任务记录才能进行测试
2. **文件生成**：测试会实际生成Excel文件和PDF文件
3. **打印测试**：如果任务配置了打印功能，测试时也会执行打印
4. **自动退出**：测试完成后程序会自动退出，不会进入循环检查模式

## 相关文件

- `.debug` - 调试模式标记文件
- `.test` - 测试模式标记文件
- `logs/remotePrinter.db` - 任务记录数据库


# 数据库回滚工具使用说明

## 功能描述

`rollback_db.py` 是一个数据库回滚工具，可以清除指定日期之后的所有操作记录。主要用于：

- 清理测试数据
- 回滚错误的批量操作
- 重置数据库到某个时间点

## 使用方法

### 方式1：交互式使用

直接运行脚本，按提示操作：

```bash
python rollback_db.py
```

程序会：
1. 显示数据库当前状态（各表的记录数和日期范围）
2. 提示输入回滚日期
3. 显示将要删除的记录预览
4. 要求确认操作（需要两次确认）
5. 执行回滚并显示结果

### 方式2：命令行参数

直接指定日期：

```bash
python rollback_db.py "2026-01-16"
```

或指定具体时间：

```bash
python rollback_db.py "2026-01-16 10:30:00"
```

## 支持的日期格式

- `2026-01-16`
- `2026-01-16 10:30:00`
- `2026/01/16`
- `2026/01/16 10:30:00`

## 回滚范围

回滚操作会删除三个表中指定日期（包含）之后的所有记录：

1. **records 表** - 已处理的任务记录
2. **ids_cache 表** - 钉钉实例ID缓存
3. **tasks 表** - 待处理任务队列

## 使用示例

### 示例1：回滚今天的所有记录

```bash
python rollback_db.py "2026-01-16"
```

### 示例2：回滚某个时间点之后的记录

```bash
python rollback_db.py "2026-01-16 14:30:00"
```

### 示例3：交互式使用

```bash
$ python rollback_db.py
============================================================
数据库回滚工具
============================================================

============================================================
数据库当前状态：
============================================================

【records表】
  总记录数: 150
  最早记录: 2026-01-10 08:00:00
  最新记录: 2026-01-16 15:30:00

【ids_cache表】
  总记录数: 80
  最早记录: 2026-01-10 08:00:00
  最新记录: 2026-01-16 15:30:00

【tasks表】
  总记录数: 5
  最早记录: 2026-01-15 10:00:00
  最新记录: 2026-01-16 14:00:00
============================================================

请输入要回滚的日期（该日期之后的记录将被删除）
支持格式: 2026-01-16 或 2026-01-16 10:30:00

回滚日期: 2026-01-16

============================================================
回滚预览 - 将删除 2026-01-16 之后的记录：
============================================================
  records: 35 条记录
  ids_cache: 20 条记录
  tasks: 3 条记录

  总计: 58 条记录
============================================================

⚠️  警告：此操作不可逆！
确定要执行回滚操作吗？ (yes/no): yes

最后确认：真的要删除这些记录吗？ (yes/no): yes

正在执行回滚操作...
============================================================
✅ 回滚成功！删除记录统计：
============================================================
  records: 35 条记录
  ids_cache: 20 条记录
  tasks: 3 条记录

  总计删除: 58 条记录
============================================================

✅ 回滚操作完成
```

## 安全机制

1. **预览功能**：执行前会显示将要删除的记录数量
2. **双重确认**：需要两次输入 `yes` 才会执行
3. **干运行模式**：预览时不会实际修改数据库
4. **日志记录**：所有操作都会记录到日志文件

## 注意事项

⚠️ **重要警告**

- 回滚操作是**不可逆**的，删除的数据无法恢复
- 建议在执行前**备份数据库**文件：`logs/remotePrinter.db`
- 回滚会删除指定日期（包含该日期）之后的所有记录
- 如果有正在运行的任务，建议先停止程序再执行回滚

## 数据库备份

执行回滚前建议备份：

```bash
# 备份数据库
cp logs/remotePrinter.db logs/remotePrinter.db.backup

# 如果需要恢复
cp logs/remotePrinter.db.backup logs/remotePrinter.db
```

## 常见场景

### 场景1：清理测试数据

在测试期间创建了很多测试记录，想要清除：

```bash
python rollback_db.py "2026-01-16 09:00:00"
```

### 场景2：重置到昨天

```bash
python rollback_db.py "2026-01-15"
```

### 场景3：清空所有数据

删除数据库文件重新初始化：

```bash
rm logs/remotePrinter.db
# 程序启动时会自动创建新的空数据库
```

## 相关文件

- `rollback_db.py` - 回滚工具主程序
- `db.py` - 数据库操作模块（包含回滚函数）
- `logs/remotePrinter.db` - SQLite数据库文件

## 程序化使用

也可以在代码中直接调用回滚函数：

```python
import db

# 查看数据库状态
info = db.get_date_range_info()
print(info)

# 预览回滚（不实际删除）
result = db.rollback_records_by_date('2026-01-16', dry_run=True)
print(result)

# 执行回滚
result = db.rollback_records_by_date('2026-01-16', dry_run=False)
print(result)
```
