# タスクテンプレートシステム

統合タスクハンドラーにより、task3.py, task5.py, task6.py, task7.pyを1つのファイルで処理できるようになりました。

## ファイル構成

- **task_handler.py**: 統合タスクハンドラー（全タスクタイプを処理）
- **task_config.json**: タスク設定ファイル（テンプレートとマッピング定義）

## 設定構造 (task_config.json)

各タスクタイプには以下の設定が可能：

```json
{
  "タスク番号": {
    "name": "タスク名",
    "template": "テンプレートファイル名.xlsx",
    "title_replace": "タイトルから削除する文字列",
    "output_suffix": "出力ファイル名のサフィックス",
    "cell_mappings": {
      "セル位置": {
        "type": "マッピングタイプ",
        "key": "フィールド名",
        "format": "フォーマッタ名"
      }
    },
    "custom_processor": "カスタム処理メソッド名",
    "operation_records_start": 操作記録開始行,
    "operation_records_style": "simple/detailed",
    "operation_records_title": "操作記録のタイトル",
    "print_area": true/false,
    "print_mode": "a4/a4_singleside/conditional"
  }
}
```

### マッピングタイプ

- `business_id`: 審批編号
- `title_modified`: タイトル（title_replace適用後）
- `originator_dept`: 部門名
- `field`: フォームフィールドの値

### フォーマッタ

- `goods_detail`: 商品明細フォーマット
- `invoice_attachments`: 発票添付ファイルフォーマット

### 操作記録スタイル

- `simple`: 同意のみ表示
- `detailed`: 全操作を詳細表示

## 新しいタスクタイプの追加方法

1. **task_config.json**に新しいタスク設定を追加
2. 特殊な処理が必要な場合は**task_handler.py**にカスタムメソッドを追加
3. **main.py**の`ALL_TASKS`に新しいタスクを登録

## 使用例

```python
import task_handler

# タスク処理
result = task_handler.handle_task(
    pid="task_id",
    task_type=3,
    status="COMPLETED",
    title="タスクタイトル"
)
```

## 利点

1. **コードの重複削減**: 共通処理を1箇所で管理
2. **保守性向上**: 新しいタスクタイプを設定ファイルで追加可能
3. **柔軟性**: カスタム処理を必要に応じて追加可能
4. **統一性**: 全タスクで一貫した処理フロー


# 调试模式测试功能说明

## 功能描述

在调试模式下，可以从数据库中获取每种任务类型的最新一条记录进行测试，验证任务处理流程是否正常。

## 使用方法

### 1. 启用调试模式

创建 `.debug` 文件以启用调试模式：

```bash
touch .debug
```

### 2. 执行历史任务测试

创建 `.test` 文件以触发测试：

```bash
touch .test
```

然后运行程序：

```bash
python main.py
```

程序会：
1. 检测到 `.debug` 和 `.test` 文件
2. 从数据库中查找每种任务类型的最新记录
3. 依次执行这些任务的处理流程
4. 输出测试结果
5. 自动退出

### 3. 正常调试模式运行

如果只创建 `.debug` 文件（不创建 `.test` 文件），程序会正常运行，但：
- 不会实际处理任务（只标记为已处理）
- 不会捕获异常（便于调试）

### 4. 退出调试模式

删除 `.debug` 文件即可：

```bash
rm .debug
```

## 测试流程说明

测试功能会：

1. 查询数据库中所有任务类型
2. 对每种任务类型，获取最新的一条记录（优先COMPLETED状态）
3. 依次执行任务处理：
   - 调用 `task_handler.handle_task()`
   - 记录处理结果
   - 输出详细日志

4. 输出测试摘要

## 日志输出示例

```
========================================
调试模式：开始测试每种任务类型的最新记录
========================================
找到 4 种任务类型的最新记录

==================================================
[测试] 任务类型: 3, PID: xxxxx
[测试] 标题: 合作档口营业款付款申请, 状态: COMPLETED
==================================================
[测试成功] 任务类型 3 处理完成

...

========================================
调试模式：所有任务测试完成
========================================
```

## 注意事项

1. **数据要求**：数据库中必须存在历史任务记录才能进行测试
2. **文件生成**：测试会实际生成Excel文件和PDF文件
3. **打印测试**：如果任务配置了打印功能，测试时也会执行打印
4. **自动退出**：测试完成后程序会自动退出，不会进入循环检查模式

## 相关文件

- `.debug` - 调试模式标记文件
- `.test` - 测试模式标记文件
- `logs/remotePrinter.db` - 任务记录数据库
